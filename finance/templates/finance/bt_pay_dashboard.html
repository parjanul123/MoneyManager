{% extends 'finance/base.html' %}
{% load static %}

{% block title %}BT Pay Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="h2">
                üí≥ BT Pay Dashboard
            </h1>
        </div>
        <div class="col-md-6 text-end">
            {% if pending_count > 0 %}
            <button class="btn btn-success" id="auto-categorize-btn">
                ‚ú® Auto-Categorize {{ pending_count }} Transactions
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards (30 zile) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Last 30 Days</h6>
                    <h3 class="mb-0">{{ stats_30.total_transactions }}</h3>
                    <small>transactions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Spent</h6>
                    <h3 class="mb-0">{{ stats_30.total_amount|floatformat:2 }}</h3>
                    <small>RON</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">Categories</h6>
                    <h3 class="mb-0">{{ stats_30.total_merchants }}</h3>
                    <small>merchants</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Avg/Day</h6>
                    <h3 class="mb-0">{% widthratio stats_30.total_amount 30 1 %}{% ifnotequal stats_30.total_transactions 0 %}.{{ stats_30.total_transactions }}{% endifnotequal %}</h3>
                    <small>RON</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pending Transactions -->
        {% if pending_bt_pay %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">‚è≥ Pending BT Pay ({{ pending_count }})</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Merchant</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in pending_bt_pay|slice:":5" %}
                            <tr>
                                <td>
                                    <small>{{ trans.description|truncatewords:3 }}</small>
                                </td>
                                <td>
                                    <strong>{{ trans.amount|floatformat:2 }} {{ trans.currency }}</strong>
                                </td>
                                <td>
                                    <small class="text-muted">{{ trans.date|date:"M d" }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'finance:bank_transactions_pending' %}" class="btn btn-sm btn-outline-primary">
                        View All Pending ‚Üí
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Top Merchants -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üè™ Top Merchants (30 days)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Merchant</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Txs</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for merchant, data in stats_30.top_merchants.items|slice:":5" %}
                            <tr style="cursor: pointer;" onclick="window.location.href='{% url 'finance:bt_pay_merchant_detail' merchant %}'">
                                <td>
                                    <small>{{ merchant|truncatewords:2 }}</small>
                                </td>
                                <td class="text-end">
                                    <strong>{{ data.total|floatformat:2 }}</strong>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary">{{ data.count }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No transactions yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'finance:bt_pay_transactions' %}" class="btn btn-sm btn-outline-info">
                        View All Transactions ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üìà Monthly Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üìä Spending by Category (30 days)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Transactions</th>
                                <th>Total</th>
                                <th>Average</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category, data in stats_30.transactions_by_category.items %}
                            <tr>
                                <td>
                                    <a href="{% url 'finance:bt_pay_transactions' %}?category={{ category }}">
                                        {{ category|title }}
                                    </a>
                                </td>
                                <td>{{ data.count }}</td>
                                <td><strong>{{ data.total|floatformat:2 }} RON</strong></td>
                                <td>{{ data.total|safe|add:"-" }}{{ data.count|safe|add:"-" }}
                                    <small>RON</small>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {% widthratio data.total stats_30.total_amount 100 %}%;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No data yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-4">
            <a href="{% url 'finance:bt_pay_transactions' %}" class="btn btn-outline-primary w-100 mb-2">
                üìã View All Transactions
            </a>
        </div>
        <div class="col-md-4">
            <a href="{% url 'finance:bt_pay_category_analysis' %}" class="btn btn-outline-info w-100 mb-2">
                üìä Detailed Analysis
            </a>
        </div>
        <div class="col-md-4">
            <a href="{% url 'finance:bank_transactions_pending' %}" class="btn btn-outline-warning w-100 mb-2">
                ‚è≥ Review & Categorize
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Chart
    const ctx = document.getElementById('monthlyChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ months|safe|json_script:"months_data" }},
                datasets: [{
                    label: 'Monthly Spending (RON)',
                    data: {{ months|safe|json_script:"amounts_data" }},
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Auto-categorize button
    document.getElementById('auto-categorize-btn')?.addEventListener('click', function() {
        if (confirm('Auto-categorize all pending BT Pay transactions?')) {
            fetch('{% url "finance:bt_pay_auto_categorize" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(e => alert('Error: ' + e));
        }
    });
});
</script>
{% endblock %}
